# AI Custom Log Tables Design

This document describes the design for extending AI agent log analysis functions to support custom log tables provided by server modules.

## Overview

Currently, the AI agent has 7 log functions in `src/server/aitools/logs.cpp` that query 4 hardcoded tables: `syslog`, `win_event_log`, `snmp_trap_log`, `event_log`. Server modules can define custom log tables via `NXCORE_LOG` structure, but these are not accessible to the AI agent.

This design extends the AI agent to discover, search, analyze, and correlate logs from any module-provided table using the existing `NXCORE_LOG` infrastructure.

## Design Decisions

1. **NXCORE_LOG extension** - Add `aiDescription` field for AI context
2. **Unified functions** - Single `search-log` function with `log_name` parameter replaces separate per-log functions
3. **Schema-based filtering** - AI discovers log schema via `get-log-schema`, uses `LC_*` column types for semantic understanding
4. **Two discovery functions** - `list-logs` for overview, `get-log-schema` for details
5. **Automatic correlation** - Module logs with `relatedObjectIdColumn` and `LC_TIMESTAMP` participate in cross-log correlation

## NXCORE_LOG Extension

**Change to `src/server/include/nxcore_logs.h`:**

```cpp
struct NXCORE_LOG
{
   const wchar_t *name;                    // Log name (shown in UI)
   const wchar_t *table;                   // Database table name
   const wchar_t *idColumn;                // Primary key column
   const wchar_t *relatedObjectIdColumn;   // Object reference column
   uint64_t requiredAccess;                // Required permission
   const char *aiDescription;              // AI context description (UTF-8)
   LOG_COLUMN columns[32];                 // Column definitions
};
```

**Example usage in a module:**

```cpp
static NXCORE_LOG s_logs[] = {
   {
      _T("AtmTransactions"),
      _T("atm_transactions"),
      _T("id"),
      _T("node_id"),
      SYSTEM_ACCESS_VIEW_EVENT_LOG,
      "ATM transaction log recording all customer transactions including "
      "withdrawals, deposits, balance inquiries, and transfers. Contains "
      "transaction status, amounts, and error codes for troubleshooting.",
      {
         { _T("id"), _T("Transaction Id"), LC_TEXT, 0 },
         { _T("node_id"), _T("ATM"), LC_OBJECT_ID, LCF_INCLUDE_IN_DETAILS },
         { _T("txn_timestamp"), _T("Timestamp"), LC_TIMESTAMP, LCF_INCLUDE_IN_DETAILS },
         // ... more columns ...
         { nullptr, nullptr, 0 }
      }
   },
   { nullptr, nullptr, nullptr, nullptr, 0, nullptr }
};
```

Modules without AI description can set `aiDescription` to `nullptr` - the AI will still see the log but with less context.

## Discovery Functions

### Function: `list-logs`

Returns all available logs the user has access to, with names and descriptions.

```json
{
   "name": "list-logs",
   "description": "List all available log sources for searching and analysis",
   "parameters": {}
}
```

**Response format:**

```json
{
   "logs": [
      {
         "name": "syslog",
         "description": "RFC 5424 syslog messages from network devices and servers...",
         "objectColumn": "source_object_id"
      },
      {
         "name": "EventLog",
         "description": "NetXMS internal events generated by the monitoring system...",
         "objectColumn": "event_source"
      },
      {
         "name": "AtmTransactions",
         "description": "ATM transaction log recording all customer transactions...",
         "objectColumn": "node_id"
      }
   ]
}
```

The `objectColumn` field (derived from `relatedObjectIdColumn`) tells AI which logs support object-based filtering and correlation.

### Function: `get-log-schema`

Returns detailed column information for a specific log.

```json
{
   "name": "get-log-schema",
   "parameters": {
      "log_name": { "type": "string", "required": true }
   }
}
```

**Response format:**

```json
{
   "name": "AtmTransactions",
   "description": "ATM transaction log recording all customer transactions...",
   "columns": [
      { "name": "id", "description": "Transaction Id", "type": "text", "isRecordId": true },
      { "name": "node_id", "description": "ATM", "type": "object_id" },
      { "name": "txn_timestamp", "description": "Timestamp", "type": "timestamp" },
      { "name": "txn_type", "description": "Type", "type": "integer" },
      { "name": "status", "description": "Status", "type": "text" },
      { "name": "amount", "description": "Amount", "type": "integer" }
   ]
}
```

Column `type` is mapped from `LC_*` constants to human-readable strings (`LC_TIMESTAMP` → `"timestamp"`, `LC_SEVERITY` → `"severity"`, etc.).

## Log Name Resolution

Logs can be referenced by either their display name (`NXCORE_LOG.name`) or table name (`NXCORE_LOG.table`):

- `"syslog"` → matches table name `syslog`
- `"WindowsEventLog"` → matches log name, or `"win_event_log"` → matches table name
- `"EventLog"` → matches log name, or `"event_log"` → matches table name
- `"AtmTransactions"` → matches log name, or `"atm_transactions"` → matches table name

**Implementation:**

```cpp
NXCORE_LOG *FindLogByName(const TCHAR *name)
{
   // Check built-in logs
   for (int i = 0; s_logs[i].name != nullptr; i++)
   {
      if (!_tcsicmp(s_logs[i].name, name) || !_tcsicmp(s_logs[i].table, name))
         return &s_logs[i];
   }

   // Check module logs
   ENUMERATE_MODULES(logs)
   {
      for (int i = 0; CURRENT_MODULE.logs[i].name != nullptr; i++)
      {
         if (!_tcsicmp(CURRENT_MODULE.logs[i].name, name) ||
             !_tcsicmp(CURRENT_MODULE.logs[i].table, name))
            return &CURRENT_MODULE.logs[i];
      }
   }

   return nullptr;
}
```

## Unified Search Function

**Replaces:** `search-syslog`, `search-windows-events`, `search-snmp-traps`, `search-events`

```json
{
   "name": "search-log",
   "description": "Search any log source with flexible filtering",
   "parameters": {
      "log_name": { "type": "string", "required": true },
      "time_from": { "type": "string", "description": "Start time (relative like -1h or ISO 8601)" },
      "time_to": { "type": "string", "description": "End time" },
      "object": { "type": "string", "description": "Object name or ID to filter by" },
      "text_pattern": { "type": "string", "description": "Text pattern to search in text columns" },
      "filters": {
         "type": "object",
         "description": "Column-specific filters, e.g. {\"severity\": 3, \"facility\": 1}"
      },
      "limit": { "type": "integer", "default": 100, "max": 1000 }
   }
}
```

**Implementation logic:**

1. Look up `NXCORE_LOG` by name (built-in + module logs)
2. Check user has `requiredAccess` permission
3. Find timestamp column (first `LC_TIMESTAMP`) for time filtering
4. Find object column (`relatedObjectIdColumn`) for object filtering
5. Find text columns (`LC_TEXT`, `LC_TEXT_DETAILS`) for pattern matching
6. Apply `filters` object to matching column names with type validation
7. Build and execute query

**Example calls:**

```json
// Search syslog
{ "log_name": "syslog", "time_from": "-1h", "filters": { "severity": 3 } }

// Search module log
{ "log_name": "AtmTransactions", "object": "ATM-001",
  "filters": { "txn_type": 1, "status": "FAILED" } }
```

## Statistics Function

```json
{
   "name": "get-log-statistics",
   "description": "Get volume statistics and trends for any log source",
   "parameters": {
      "log_name": { "type": "string", "required": true },
      "time_from": { "type": "string", "default": "-24h" },
      "time_to": { "type": "string" },
      "group_by": { "type": "string", "enum": ["hour", "day", "week"], "default": "hour" },
      "object": { "type": "string", "description": "Optional object filter" }
   }
}
```

Implementation finds the `LC_TIMESTAMP` column for time grouping and `LC_SEVERITY` column (if present) for severity breakdown. Logs without severity get total counts only.

## Pattern Analysis Function

```json
{
   "name": "analyze-log-patterns",
   "description": "Detect patterns and anomalies in log messages",
   "parameters": {
      "log_name": { "type": "string", "required": true },
      "pattern_type": { "type": "string", "enum": ["frequency", "burst", "recurring", "new", "all"], "default": "all" },
      "time_from": { "type": "string", "default": "-24h" },
      "time_to": { "type": "string" },
      "object": { "type": "string" },
      "severity_threshold": { "type": "integer", "description": "Minimum severity to analyze" }
   }
}
```

Implementation finds `LC_TEXT` or `LC_TEXT_DETAILS` columns for message normalization and pattern detection. Logs without text columns return an error indicating pattern analysis isn't applicable.

## Correlation Function

```json
{
   "name": "correlate-logs",
   "description": "Correlate events across multiple log sources for a device",
   "parameters": {
      "object": { "type": "string", "required": true, "description": "Object name or ID" },
      "time_from": { "type": "string", "default": "-1h" },
      "time_to": { "type": "string" },
      "include_neighbors": { "type": "boolean", "default": false, "description": "Include L2 neighbors" },
      "log_sources": {
         "type": "array",
         "description": "Specific logs to correlate (default: all applicable logs)"
      },
      "limit_per_source": { "type": "integer", "default": 50, "max": 200 }
   }
}
```

**Implementation logic:**

1. Find all logs where `relatedObjectIdColumn` is not null (logs that can be associated with objects)
2. If `log_sources` specified, filter to only those logs
3. For each applicable log:
   - Find `LC_TIMESTAMP` column for time ordering
   - Find `LC_SEVERITY` column (if present) for severity info
   - Find `LC_TEXT`/`LC_TEXT_DETAILS` for message content
   - Query records matching object and time range
4. Merge all results into unified timeline sorted by timestamp
5. Normalize messages for pattern matching across sources

**Response format:**

```json
{
   "object": "Router-01",
   "time_range": { "from": "2026-01-18T10:00:00Z", "to": "2026-01-18T11:00:00Z" },
   "events": [
      { "timestamp": "...", "source": "syslog", "severity": 3, "message": "..." },
      { "timestamp": "...", "source": "EventLog", "severity": 2, "message": "..." },
      { "timestamp": "...", "source": "AtmTransactions", "message": "...", "txn_type": 1 }
   ],
   "sources_queried": ["syslog", "EventLog", "snmp_trap_log", "AtmTransactions"]
}
```

Module logs automatically participate when they have both `relatedObjectIdColumn` and a `LC_TIMESTAMP` column.

## Implementation Summary

**Files to modify:**

| File | Changes |
|------|---------|
| `src/server/include/nxcore_logs.h` | Add `const char *aiDescription` to `NXCORE_LOG` |
| `src/server/core/logs.cpp` | Add `aiDescription` to built-in log definitions |
| `src/server/aitools/logs.cpp` | Refactor to unified functions using `NXCORE_LOG` lookup |
| `src/server/aitools/main.cpp` | Update function registrations |

**New/changed AI functions:**

| Old | New |
|-----|-----|
| `search-syslog`, `search-windows-events`, `search-snmp-traps`, `search-events` | `search-log` |
| `get-log-statistics` (hardcoded) | `get-log-statistics` (generic) |
| `analyze-log-patterns` (hardcoded) | `analyze-log-patterns` (generic) |
| `correlate-logs` (hardcoded) | `correlate-logs` (generic) |
| — | `list-logs` (new) |
| — | `get-log-schema` (new) |

**Module author workflow:**

1. Define `NXCORE_LOG` with `aiDescription` explaining the log's purpose
2. Ensure columns use appropriate `LC_*` types
3. Log automatically becomes available to AI for search, statistics, patterns, and correlation
